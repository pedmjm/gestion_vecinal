{% extends "base.html" %}

{% block title %}{{ 'Editar Producto' if tipo == 'producto' else 'Editar Servicio' }}{% endblock %}

{% block content %}
    <!-- Header Navigation -->
    <div class="section" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h1 style="margin: 0;">{{ 'Editar Producto' if tipo == 'producto' else 'Editar Servicio' }}</h1>
        <a href="{{ url_for('dashboard') }}" style="text-decoration: none; color: #007bff; font-weight: bold;">
            &larr; Volver al Dashboard
        </a>
    </div>

    <!-- Formulario de Edición -->
    <div class="section">
        <h2 class="section-title">Información del {{ 'Producto' if tipo == 'producto' else 'Servicio' }}</h2>
        <form method="POST" id="editForm" style="max-width: 800px; margin: 0 auto;">
            
            <!-- Nombre -->
            <div class="form-group" style="margin-bottom: 20px;">
                <label for="nombre" style="display: block; margin-bottom: 8px; font-weight: bold;">Nombre</label>
                <input type="text" id="nombre" name="nombre" class="form-control" 
                       value="{{ item.nombre }}" required 
                       style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
            </div>

            <!-- Descripción -->
            <div class="form-group" style="margin-bottom: 20px;">
                <label for="descripcion" style="display: block; margin-bottom: 8px; font-weight: bold;">Descripción</label>
                <textarea id="descripcion" name="descripcion" class="form-control" required 
                          style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; min-height: 100px; resize: vertical;">{{ item.descripcion }}</textarea>
            </div>

            <!-- Precio y Campos Condicionales -->
            <div style="display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap;">
                <!-- Precio -->
                <div style="flex: 1; min-width: 200px;">
                    <div class="form-group">
                        <label for="precio" style="display: block; margin-bottom: 8px; font-weight: bold;">Precio ($)</label>
                        <input type="number" id="precio" name="precio" class="form-control" step="0.01" min="0" 
                               value="{{ item.precio }}" required 
                               style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    </div>
                </div>
                
                <!-- Stock (Solo para Productos) -->
                {% if tipo == 'producto' %}
                <div style="flex: 1; min-width: 200px;">
                    <div class="form-group">
                        <label for="stock" style="display: block; margin-bottom: 8px; font-weight: bold;">Stock Disponible</label>
                        <input type="number" id="stock" name="stock" class="form-control" min="0" 
                               value="{{ item.stock }}" 
                               style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    </div>
                </div>
                {% endif %}

                <!-- Duración (Solo para Servicios) -->
                {% if tipo == 'servicio' %}
                <div style="flex: 1; min-width: 200px;">
                    <div class="form-group">
                        <label for="duracion" style="display: block; margin-bottom: 8px; font-weight: bold;">Duración</label>
                        <input type="text" id="duracion" name="duracion" class="form-control" 
                               placeholder="Ej: 1 hora, 30 min" value="{{ item.duracion }}" 
                               style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Categorías y Subcategorías -->
            <div style="display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap;">
                <!-- Categoría -->
                <div style="flex: 1; min-width: 200px;">
                    <div class="form-group">
                        <label for="categoria" style="display: block; margin-bottom: 8px; font-weight: bold;">Categoría</label>
                        <select id="categoria" name="categoria" class="form-control" 
                                style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                            <option value="">-- Sin Categoría --</option>
                            {% for cat in categorias %}
                            <option value="{{ cat.id }}" {% if item.categoria_id == cat.id %}selected{% endif %}>
                                {{ cat.nombre }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <!-- Subcategoría -->
                <div style="flex: 1; min-width: 200px;">
                    <div class="form-group">
                        <label for="subcategoria" style="display: block; margin-bottom: 8px; font-weight: bold;">Subcategoría</label>
                        <select id="subcategoria" name="subcategoria" class="form-control" 
                                style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                            <option value="">-- Seleccionar Categoría Primero --</option>
                            <!-- Cargaremos dinámicamente las subcategorías -->
                        </select>
                        <input type="hidden" id="current_subcategoria_id" value="{{ item.subcategoria_id or '' }}">
                        <input type="hidden" id="current_categoria_id" value="{{ item.categoria_id or '' }}">
                    </div>
                </div>
            </div>

            <!-- URL de la Imagen -->
            <div class="form-group" style="margin-bottom: 20px;">
                <label for="imagen_url" style="display: block; margin-bottom: 8px; font-weight: bold;">URL de la Imagen</label>
                <input type="url" id="imagen_url" name="imagen_url" class="form-control" 
                       placeholder="https://..." value="{{ item.imagen_url or '' }}" 
                       style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                
                <!-- Previsualización de Imagen -->
                <div style="margin-top: 10px; text-align: center; border: 2px dashed #ddd; padding: 20px; border-radius: 8px; background: #fafafa;">
                    <img id="preview_img" src="{{ item.imagen_url or '' }}" 
                         style="max-width: 100%; max-height: 200px; object-fit: contain; border-radius: 4px; {% if not item.imagen_url %}display: none;{% endif %}">
                    <p id="no_img_text" style="color: #999; margin: 10px 0; {% if item.imagen_url %}display: none;{% endif %}">
                        No hay imagen para mostrar
                    </p>
                </div>
            </div>

            <!-- Botones de Acción -->
            <div style="display: flex; justify-content: flex-end; gap: 15px; margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee;">
                <a href="{{ url_for('dashboard') }}" 
                   style="padding: 12px 24px; background-color: #6c757d; color: white; text-decoration: none; border-radius: 5px; font-weight: bold;">
                    Cancelar
                </a>
                <button type="submit" 
                        style="padding: 12px 24px; background-color: #007bff; color: white; border: none; border-radius: 5px; font-weight: bold; cursor: pointer;">
                    Guardar Cambios
                </button>
            </div>
        </form>
    </div>

<script>
console.log("Edit Product/Service Script Loaded"); // Immediate check

document.addEventListener('DOMContentLoaded', function() {
    const categoriaSelect = document.getElementById('categoria');
    const subcategoriaSelect = document.getElementById('subcategoria');
    const currentSubcatId = document.getElementById('current_subcategoria_id').value;
    
    console.log('Initial IDs:', { 
        cat: categoriaSelect.value, 
        sub: currentSubcatId 
    });

    async function updateSubcategories(categoriaId, selectedSubId = null) {
        if (!categoriaId) {
            subcategoriaSelect.innerHTML = '<option value="">-- Seleccionar Categoría Primero --</option>';
            return;
        }

        subcategoriaSelect.innerHTML = '<option value="">Cargando...</option>';

        try {
            const response = await fetch(`/api/subcategorias/${categoriaId}`);
            const data = await response.json();
            
            // Normalize data: handling both array and {subcategorias: []} formats
            const subcategorias = Array.isArray(data) ? data : (data.subcategorias || data.data || []);
            
            subcategoriaSelect.innerHTML = '<option value="">-- Ninguna --</option>';

            subcategorias.forEach(sub => {
                const option = document.createElement('option');
                // Adjust property names based on your specific Flask API response
                option.value = sub.id || sub.subcategoria_id;
                option.textContent = sub.nombre || sub.subcategoria_nombre;
                
                if (selectedSubId && option.value.toString() === selectedSubId.toString()) {
                    option.selected = true;
                }
                subcategoriaSelect.appendChild(option);
            });

        } catch (error) {
            console.error('Fetch error:', error);
            subcategoriaSelect.innerHTML = '<option value="">Error al cargar</option>';
        }
    }

    // Event for manual change
    categoriaSelect.addEventListener('change', (e) => {
        updateSubcategories(e.target.value);
    });

    // Auto-load on page start
    if (categoriaSelect.value) {
        updateSubcategories(categoriaSelect.value, currentSubcatId);
    }
});

// Image Preview logic
const imagenInput = document.getElementById('imagen_url');
if (imagenInput) {
    imagenInput.addEventListener('input', function() {
        const previewImg = document.getElementById('preview_img');
        const noImgText = document.getElementById('no_img_text');
        if (this.value.trim()) {
            previewImg.src = this.value;
            previewImg.style.display = 'block';
            noImgText.style.display = 'none';
        } else {
            previewImg.style.display = 'none';
            noImgText.style.display = 'block';
        }
    });
}
</script>
{% endblock %}